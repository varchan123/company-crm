<!DOCTYPE html>
<html>
<head>
    <title>Company CRM</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style> body { padding: 20px; } </style>
</head>
<body>
    <div class="container">
        <h1>Company Database Manager</h1>

        <!-- Search Section -->
        <h2>Search Company</h2>
        <input type="text" id="searchInput" class="form-control mb-2" placeholder="Enter company name" style="width:300px;">
        <button class="btn btn-primary" onclick="searchCompany()">Search</button>
        <div id="searchResults" class="mt-3"></div>

        <!-- Add Section -->
        <h2 class="mt-4">Add New POC</h2>
        <form id="addForm">
            <input type="text" id="name" class="form-control mb-2" placeholder="Company Name" required style="width:300px;">
            <input type="text" id="poc" class="form-control mb-2" placeholder="POC Name" style="width:300px;">
            <input type="text" id="designation" class="form-control mb-2" placeholder="Designation" style="width:300px;">
            <input type="text" id="mobile" class="form-control mb-2" placeholder="Mobile No" style="width:300px;">
            <input type="email" id="email" class="form-control mb-2" placeholder="Email" style="width:300px;">
            <button type="button" class="btn btn-success" onclick="addCompany()">Add</button>
        </form>

        <!-- Update Section -->
        <h2 class="mt-4">Update POC</h2>
        <div id="updateForm" style="display:none;">
            <input type="hidden" id="updateId">
            <input type="text" id="updateName" class="form-control mb-2" placeholder="New Company Name" style="width:300px;">
            <input type="text" id="updatePoc" class="form-control mb-2" placeholder="New POC Name" style="width:300px;">
            <input type="text" id="updateDesignation" class="form-control mb-2" placeholder="New Designation" style="width:300px;">
            <input type="text" id="updateMobile" class="form-control mb-2" placeholder="New Mobile" style="width:300px;">
            <input type="email" id="updateEmail" class="form-control mb-2" placeholder="New Email" style="width:300px;">
            <button type="button" class="btn btn-warning" onclick="updateCompany()">Update</button>
        </div>
    </div>

    <script>
        async function searchCompany() {
            const name = document.getElementById('searchInput').value;
            if (!name) return;
            const response = await fetch(`/search/${name}`);
            const json = await response.json();
            const data = json.results;
            const count = json.count;
            
            if (count === 0) {
                document.getElementById('searchResults').innerHTML = '<p class="alert alert-warning">No matches.</p>';
                return;
            }
            
            let html = `<h4>${count} POC(s) for "${name}"</h4>
                        <table class="table table-striped">
                        <thead><tr><th>POC Name</th><th>Designation</th><th>Mobile</th><th>Email</th><th>Actions</th></tr></thead>
                        <tbody>`;
            data.forEach(c => {
                html += `<tr>
                         <td>${c.poc_name || 'N/A'}</td>
                         <td>${c.designation || 'N/A'}</td>
                         <td>${c.mobile || 'N/A'}</td>
                         <td>${c.email || 'N/A'}</td>
                         <td><button class="btn btn-sm btn-info" onclick="loadUpdate(${c.id}, '${c.name.replace(/'/g, "\\'")}', '${(c.poc_name || '').replace(/'/g, "\\'")}', '${(c.designation || '').replace(/'/g, "\\'")}', '${(c.mobile || '').replace(/'/g, "\\'")}', '${(c.email || '').replace(/'/g, "\\'")}')">Edit</button></td>
                         </tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('searchResults').innerHTML = html;
        }

        async function addCompany() {
            const data = {
                name: document.getElementById('name').value,
                poc_name: document.getElementById('poc').value,
                designation: document.getElementById('designation').value,
                mobile: document.getElementById('mobile').value,
                email: document.getElementById('email').value
            };
            if (!data.name) return alert('Company name required!');
            await fetch('/add', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
            alert('Added!');
            document.getElementById('addForm').reset();
        }

        function loadUpdate(id, name, poc, designation, mobile, email) {
            document.getElementById('updateId').value = id;
            document.getElementById('updateName').value = name;
            document.getElementById('updatePoc').value = poc;
            document.getElementById('updateDesignation').value = designation;
            document.getElementById('updateMobile').value = mobile;
            document.getElementById('updateEmail').value = email;
            document.getElementById('updateForm').style.display = 'block';
        }

        async function updateCompany() {
            const id = document.getElementById('updateId').value;
            const data = {
                name: document.getElementById('updateName').value,
                poc_name: document.getElementById('updatePoc').value,
                designation: document.getElementById('updateDesignation').value,
                mobile: document.getElementById('updateMobile').value,
                email: document.getElementById('updateEmail').value
            };
            await fetch(`/update/${id}`, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
            alert('Updated!');
            document.getElementById('updateForm').style.display = 'none';
            searchCompany();  // Refresh search results
        }
    </script>
</body>
</html>